<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>masonary layout</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js" defer></script>
</head>
<body>
  <div id="auth-section">
    <form id="login-form">
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <button id="logout-btn" style="display:none;">Logout</button>
  </div>
  <div id="upload-section" style="display:none;">
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" id="image-input" name="image" accept="image/*" multiple required>
      <button type="submit">Upload Image(s)</button>
    </form>
  </div>
  <div id="delete-selected-section" style="display:none; margin-bottom: 15px;">
    <button id="delete-selected-btn" disabled>Delete Selected</button>
    <button id="add-tags-selected-btn" disabled>Add Tags to Selected</button>
  </div>
  <div class="masonry" id="masonry"></div>

  <div id="theme-manager" class="theme-manager">
    <button id="theme-btn" class="theme-btn">ðŸŽ¨</button>
    <div id="theme-popup" class="theme-popup hidden">
      <h3>Theme Editor</h3>
      <div id="theme-list" class="theme-list"></div>
      <div class="theme-editor">
        <div class="theme-editor-header">
          <h4>Edit Theme</h4>
          <div class="theme-editor-actions">
            <button class="theme-editor-btn revert-btn" onclick="revertThemeChanges()" style="display: none;">Revert</button>
            <button class="theme-editor-btn save-btn" onclick="saveThemeChanges()" style="display: none;">Save Changes</button>
          </div>
        </div>
        <div class="theme-property">
          <label>Text Color</label>
          <input type="color" data-var="--text">
        </div>
        <div class="theme-property">
          <label>Background</label>
          <input type="color" data-var="--background">
        </div>
        <div class="theme-property">
          <label>Primary</label>
          <input type="color" data-var="--primary">
        </div>
        <div class="theme-property">
          <label>Secondary</label>
          <input type="color" data-var="--secondary">
        </div>
        <div class="theme-property">
          <label>Accent</label>
          <input type="color" data-var="--accent">
        </div>
        <div class="theme-property">
          <label>Delete Button</label>
          <input type="color" data-var="--delete">
        </div>
        <div class="theme-font-editor">
          <div class="theme-font-property">
            <label>Font Family</label>
            <select data-var="--font-family">
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Roboto', sans-serif">Roboto</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
            </select>
          </div>
          <div class="theme-font-property">
            <label>Base Font Size</label>
            <input type="number" data-var="--font-size-base" min="12" max="24" step="1">
          </div>
        </div>
      </div>
      <div class="theme-create">
        <input type="text" id="new-theme-name" placeholder="Theme name">
        <button onclick="saveCurrentTheme()">Save Theme</button>
      </div>
    </div>
  </div>

  <script>
    let msnry = null;
    let selectedImages = new Set();
    let loggedInGlobal = false;

    let tagModal = null;
    function showTagModal({ filenames, currentTags, allTags = [], onSave, images = [] }) {
      if (tagModal) tagModal.remove();
      tagModal = document.createElement('div');
      tagModal.style.position = 'fixed';
      tagModal.style.top = '0';
      tagModal.style.left = '0';
      tagModal.style.width = '100vw';
      tagModal.style.height = '100vh';
      tagModal.style.background = 'rgba(0,0,0,0.3)';
      tagModal.style.display = 'flex';
      tagModal.style.alignItems = 'center';
      tagModal.style.justifyContent = 'center';
      tagModal.style.zIndex = 2000;

      let tagSets = images.length ? images.map(img => new Set(img.tags || [])) : [new Set(allTags)];
      let allTagList = images.length
        ? Array.from(new Set([].concat(...images.map(img => img.tags || []))))
        : [...allTags];
      let commonTags = images.length
        ? allTagList.filter(tag => tagSets.every(set => set.has(tag)))
        : [...allTags];

      let tagStates = {};
      allTagList.forEach(tag => {
        if (commonTags.includes(tag)) tagStates[tag] = 'checked';
        else tagStates[tag] = 'indeterminate';
      });

      function renderTagCheckboxes() {
        return allTagList.map(tag => {
          let state = tagStates[tag];
          let checked = state === 'checked' ? 'checked' : '';
          let indeterminate = state === 'indeterminate' ? 'data-indeterminate="true"' : '';
          return `
            <label style="display:inline-flex;align-items:center;margin:2px 8px 2px 0;font-size:14px;">
              <input type="checkbox" class="tag-checkbox" data-tag="${encodeURIComponent(tag)}" ${checked} ${indeterminate} style="margin-right:6px;">
              <span>${tag}</span>
            </label>
          `;
        }).join('');
      }

      tagModal.innerHTML = `
        <div style="background:var(--background);color:var(--text);padding:30px 24px;border-radius:12px;min-width:320px;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
          <h3 style="margin-top:0;">Add/Edit Tags</h3>
          <div style="margin-bottom:16px;">
            <label style="font-size:15px;">Tags:</label>
            <div id="tag-checkbox-list" style="display:flex;flex-wrap:wrap;gap:6px 8px;margin:8px 0 8px 0;">
              ${renderTagCheckboxes()}
            </div>
            <div style="display:flex;gap:8px;">
              <input id="tag-input" type="text" style="flex:1;width:100%;padding:8px;border-radius:6px;border:1px solid var(--secondary);background:var(--background);color:var(--text);" placeholder="Add tag and press Enter">
              <button id="tag-add-btn" style="padding:6px 14px;border-radius:6px;background:var(--primary);color:var(--background);border:none;cursor:pointer;font-weight:bold;">Add</button>
            </div>
          </div>
          <div style="display:flex;gap:12px;justify-content:flex-end;">
            <button id="tag-cancel-btn" style="padding:6px 18px;border-radius:6px;background:var(--secondary);color:var(--text);border:none;cursor:pointer;">Cancel</button>
            <button id="tag-save-btn" style="padding:6px 18px;border-radius:6px;background:var(--primary);color:var(--background);border:none;cursor:pointer;font-weight:bold;">Save</button>
          </div>
        </div>
      `;
      document.body.appendChild(tagModal);

      function updateIndeterminate() {
        document.querySelectorAll('.tag-checkbox').forEach(cb => {
          const tag = decodeURIComponent(cb.dataset.tag);
          cb.indeterminate = tagStates[tag] === 'indeterminate';
        });
      }
      updateIndeterminate();

      document.getElementById('tag-checkbox-list').addEventListener('change', e => {
        if (e.target.classList.contains('tag-checkbox')) {
          const tag = decodeURIComponent(e.target.dataset.tag);
          tagStates[tag] = e.target.checked ? 'checked' : 'unchecked';
          updateIndeterminate();
        }
      });

      function addTagFromInput() {
        const input = document.getElementById('tag-input');
        let val = input.value.trim();
        if (!val) return;
        val.split(',').map(t => t.trim()).filter(Boolean).forEach(tag => {
          if (!allTagList.includes(tag)) {
            allTagList.push(tag);
            tagStates[tag] = 'checked';
          }
        });
        input.value = '';
        document.getElementById('tag-checkbox-list').innerHTML = renderTagCheckboxes();
        updateIndeterminate();
      }
      document.getElementById('tag-add-btn').onclick = addTagFromInput;
      document.getElementById('tag-input').addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          addTagFromInput();
        }
      });

      document.getElementById('tag-cancel-btn').onclick = () => tagModal.remove();
      document.getElementById('tag-save-btn').onclick = async () => {
        if (images.length > 1) {
          for (const img of images) {
            let updatedTags = new Set(img.tags || []);
            for (let tag of allTagList) {
              if (tagStates[tag] === 'checked') {
                updatedTags.add(tag);
              } else if (tagStates[tag] === 'unchecked') {
                updatedTags.delete(tag);
              }
            }
            await fetch(`/api/images/${img.filename}/tags`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
              },
              body: JSON.stringify({ tags: Array.from(updatedTags) })
            });
          }
          await onSave();
        } else {
          const tags = allTagList.filter(tag => tagStates[tag] === 'checked');
          await onSave(tags);
        }
        tagModal.remove();
      };
    }

    function renderImages(images, loggedIn) {
      const masonry = document.getElementById('masonry');
      masonry.innerHTML = '';
      const imageElements = [];
      images.forEach(imgObj => {
        const { url, filename, tags } = imgObj;
        const div = document.createElement('div');
        div.className = 'masonry-item';
        div.style.position = 'relative';

        let checkboxHtml = '';
        if (loggedIn) {
          checkboxHtml = `
            <input type="checkbox" class="select-checkbox" data-filename="${filename}" style="position:absolute;top:8px;left:8px;z-index:2;display:none;">
          `;
        }

        let tagHtml = '';
        if (tags.length) {
          tagHtml = `
            <div class="image-tags" style="position:absolute;left:8px;bottom:8px;z-index:2;display:flex;flex-direction:column;align-items:flex-start;gap:4px;pointer-events:none;opacity:0;transition:opacity 0.2s;">
              ${tags.map(t => `<div class="image-tag-box">${t}</div>`).join('')}
            </div>
          `;
        } else {
          tagHtml = `
            <div class="image-tags" style="position:absolute;left:8px;bottom:8px;z-index:2;display:flex;flex-direction:column;align-items:flex-start;gap:4px;pointer-events:none;opacity:0;transition:opacity 0.2s;"></div>
          `;
        }

        div.innerHTML = `
          ${checkboxHtml}
          <img src="${url}">
          ${tagHtml}
        `;

        const tagDiv = div.querySelector('.image-tags');
        div.addEventListener('mouseenter', () => {
          tagDiv.style.opacity = '1';
        });
        div.addEventListener('mouseleave', () => {
          tagDiv.style.opacity = '0';
        });

        if (loggedIn) {
          const checkbox = div.querySelector('.select-checkbox');
          if (selectedImages.has(filename)) {
            checkbox.checked = true;
            checkbox.style.display = 'block';
            div.classList.add('selected');
          }
          div.addEventListener('mouseenter', () => {
            checkbox.style.display = 'block';
          });
          div.addEventListener('mouseleave', () => {
            if (!checkbox.checked) checkbox.style.display = 'none';
          });
          checkbox.addEventListener('change', (e) => {
            if (checkbox.checked) {
              selectedImages.add(filename);
              checkbox.style.display = 'block';
              div.classList.add('selected');
            } else {
              selectedImages.delete(filename);
              checkbox.style.display = 'none';
              div.classList.remove('selected');
            }
            updateDeleteSelectedBtn();
            updateAddTagsSelectedBtn();
          });
        }

        if (loggedIn) {
          const btn = document.createElement('button');
          btn.innerHTML = '&times;';
          btn.className = 'delete-btn';
          btn.title = 'Delete';
          btn.onclick = () => deleteImage(filename);
          div.appendChild(btn);

          const tagEditBtn = document.createElement('button');
          tagEditBtn.innerHTML = 'ðŸ·ï¸';
          tagEditBtn.title = 'Edit tags';
          tagEditBtn.className = 'tag-edit-btn';
          tagEditBtn.style.position = 'absolute';
          tagEditBtn.style.right = '8px';
          tagEditBtn.style.bottom = '8px';
          tagEditBtn.style.zIndex = 3;
          tagEditBtn.style.background = 'var(--primary)';
          tagEditBtn.style.color = 'var(--background)';
          tagEditBtn.style.border = 'none';
          tagEditBtn.style.borderRadius = '8px';
          tagEditBtn.style.padding = '2px 8px';
          tagEditBtn.style.fontSize = '15px';
          tagEditBtn.style.cursor = 'pointer';
          tagEditBtn.style.opacity = '0.85';
          tagEditBtn.style.transition = 'background 0.2s, color 0.2s';
          tagEditBtn.onmouseenter = () => tagEditBtn.style.opacity = '1';
          tagEditBtn.onmouseleave = () => tagEditBtn.style.opacity = '0.85';
          tagEditBtn.onclick = (e) => {
            e.stopPropagation();
            showTagModal({
              filenames: [filename],
              currentTags: tags,
              allTags: tags,
              onSave: async (newTags) => {
                await fetch(`/api/images/${filename}/tags`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getToken()
                  },
                  body: JSON.stringify({ tags: newTags })
                });
                loadImages();
              }
            });
          };
          div.appendChild(tagEditBtn);
        }

        masonry.appendChild(div);
        imageElements.push(div.querySelector('img'));
      });

      Promise.all(
        imageElements.map(img => {
          if (img.complete) return Promise.resolve();
          return new Promise(resolve => {
            img.onload = img.onerror = resolve;
          });
        })
      ).then(() => {
        if (msnry) msnry.destroy();
        msnry = new Masonry('.masonry', {
          itemSelector: '.masonry-item',
          columnWidth: '.masonry-item',
          gutter: 15,
          horizontalOrder: true
        });
      });
    }

    function updateDeleteSelectedBtn() {
      const btn = document.getElementById('delete-selected-btn');
      btn.disabled = selectedImages.size === 0;
    }
    function updateAddTagsSelectedBtn() {
      const btn = document.getElementById('add-tags-selected-btn');
      btn.disabled = selectedImages.size === 0;
    }

    async function loadImages() {
      const res = await fetch('/api/images');
      const images = await res.json();
      renderImages(images, loggedInGlobal);
    }

    document.getElementById('login-form').onsubmit = async e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('token', data.token);
        setAuthUI(true);
        loadImages();
      } else {
        alert('Login failed');
      }
    };

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('token');
      setAuthUI(false);
      loadImages();
    };

    document.getElementById('upload-form').onsubmit = async e => {
      e.preventDefault();
      const fileInput = document.getElementById('image-input');
      if (!fileInput.files.length) return;
      const formData = new FormData();
      for (const file of fileInput.files) {
        formData.append('image', file);
      }
      const res = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + getToken() },
        body: formData
      });
      if (res.ok) {
        fileInput.value = '';
        loadImages();
      } else {
        alert('Upload failed');
      }
    };

    async function deleteImage(filename) {
      if (!confirm('Delete this image?')) return;
      const res = await fetch('/api/images/' + filename, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      if (res.ok) {
        selectedImages.delete(filename);
        updateDeleteSelectedBtn();
        loadImages();
      }
      else alert('Delete failed');
    }

    async function deleteSelectedImages() {
      if (selectedImages.size === 0) return;
      if (!confirm('Delete selected images?')) return;
      const filenames = Array.from(selectedImages);
      let failed = false;
      for (const filename of filenames) {
        const res = await fetch('/api/images/' + filename, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        if (!res.ok) failed = true;
      }
      selectedImages.clear();
      updateDeleteSelectedBtn();
      loadImages();
      if (failed) alert('Some images could not be deleted.');
    }

    document.getElementById('delete-selected-btn').onclick = deleteSelectedImages;

    document.getElementById('add-tags-selected-btn').onclick = async () => {
      if (selectedImages.size === 0) return;
      const res = await fetch('/api/images');
      const images = await res.json();
      const selected = images.filter(img => selectedImages.has(img.filename));
      let allTags = [];
      if (selected.length > 0) {
        const tagSet = new Set();
        selected.forEach(img => (img.tags || []).forEach(tag => tagSet.add(tag)));
        allTags = Array.from(tagSet);
      }
      showTagModal({
        filenames: Array.from(selectedImages),
        currentTags: [],
        allTags,
        images: selected,
        onSave: async () => {
          loadImages();
        }
      });
    };

    function getToken() {
      return localStorage.getItem('token');
    }

    function setAuthUI(loggedIn) {
      document.getElementById('login-form').style.display = loggedIn ? 'none' : '';
      document.getElementById('logout-btn').style.display = loggedIn ? '' : 'none';
      document.getElementById('upload-section').style.display = loggedIn ? '' : 'none';
      document.getElementById('delete-selected-section').style.display = loggedIn ? '' : 'none';
      loggedInGlobal = loggedIn;
      if (!loggedIn) {
        selectedImages.clear();
        updateDeleteSelectedBtn();
        updateAddTagsSelectedBtn();
      }
    }

    async function checkLogin() {
      const token = getToken();
      if (!token) {
        setAuthUI(false);
        loadImages();
        return;
      }
      const res = await fetch('/api/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      setAuthUI(data.valid);
      loadImages();
    }

    document.addEventListener("DOMContentLoaded", checkLogin);
  </script>
  <script>
    let originalThemeValues = {};

    document.getElementById('theme-btn').addEventListener('click', () => {
      document.getElementById('theme-popup').classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      const popup = document.getElementById('theme-popup');
      const btn = document.getElementById('theme-btn');
      if (!popup.contains(e.target) && !btn.contains(e.target)) {
        popup.classList.add('hidden');
      }
    });

    async function loadThemes() {
      try {
        const response = await fetch('/api/themes');
        const themes = await response.json();
        const themeList = document.getElementById('theme-list');
        themeList.innerHTML = themes.map(theme => `
          <div class="theme-item">
            <input type="text" class="theme-name-input"
              value="${theme.name}"
              onchange="updateThemeName(${theme.id}, this.value)"
              ${Number(theme.is_default) ? 'disabled' : ''}>
            <div class="theme-item-actions">
              <button onclick="applyTheme(${theme.id})" class="theme-apply">Apply Theme</button>
              ${!Number(theme.is_default) ? `<button onclick="deleteTheme(${theme.id}, event)" class="delete-btn">Remove</button>` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading themes:', error);
      }
    }

    async function updateThemeName(id, newName) {
      if (!newName.trim()) return;
      try {
        const response = await fetch(`/api/themes/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName.trim() })
        });
        if (!response.ok) {
          const error = await response.json();
          alert(error.error);
          await loadThemes();
        }
      } catch (error) {
        console.error('Error updating theme name:', error);
        await loadThemes();
      }
    }

    function rgbToHex(color) {
      if (color.startsWith('#')) return color;
      const rgb = color.match(/\d+/g);
      if (!rgb) return '#000000';
      const r = parseInt(rgb[0]);
      const g = parseInt(rgb[1]);
      const b = parseInt(rgb[2]);
      return '#' + [r, g, b].map(x => {
        const hex = x.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    async function applyTheme(id) {
      try {
        const response = await fetch('/api/themes');
        const themes = await response.json();
        const theme = themes.find(t => t.id === id);
        if (!theme) return;
        const colors = JSON.parse(theme.colors);
        localStorage.setItem('activeThemeId', id);
        Object.entries(colors).forEach(([key, value]) => {
          document.documentElement.style.setProperty(`--${key}`, value);
        });
        document.querySelectorAll('.theme-property input[type="color"]').forEach(input => {
          const varName = input.dataset.var;
          if (varName) {
            const colorName = varName.substring(2);
            if (colors[colorName]) {
              input.value = rgbToHex(colors[colorName]);
            }
          }
        });
        document.querySelectorAll('.theme-font-property input, .theme-font-property select').forEach(input => {
          const varName = input.dataset.var;
          if (varName) {
            const propName = varName.substring(2);
            if (colors[propName]) {
              let value = colors[propName];
              if (input.type === 'number') {
                value = parseInt(value.replace('px', ''));
              }
              input.value = value;
            }
          }
        });
        originalThemeValues = {};
        document.querySelectorAll('[data-var]').forEach(input => {
          const varName = input.dataset.var;
          const computedValue = getComputedStyle(document.documentElement)
            .getPropertyValue(varName).trim();
          originalThemeValues[varName] = computedValue;
        });
        hideThemeButtons();
      } catch (error) {
        console.error('Error applying theme:', error);
      }
    }

    async function loadSavedTheme() {
      const savedThemeId = localStorage.getItem('activeThemeId');
      if (savedThemeId) {
        await applyTheme(parseInt(savedThemeId));
      }
    }

    function initThemeEditor() {
      const root = document.documentElement;
      const style = getComputedStyle(root);
      originalThemeValues = {};
      document.querySelectorAll('.theme-property input[type="color"]').forEach(input => {
        const varName = input.dataset.var;
        const color = style.getPropertyValue(varName).trim();
        input.value = rgbToHex(color);
        originalThemeValues[varName] = color;
        input.addEventListener('input', (e) => {
          root.style.setProperty(varName, e.target.value);
          showThemeButtons();
        });
      });
      document.querySelectorAll('.theme-font-property input, .theme-font-property select').forEach(input => {
        const varName = input.dataset.var;
        let value = style.getPropertyValue(varName).trim();
        if (input.type === 'number') {
          value = parseInt(value);
        }
        input.value = value;
        originalThemeValues[varName] = value;
        input.addEventListener('change', (e) => {
          let newValue = e.target.value;
          if (input.type === 'number') {
            newValue = `${newValue}px`;
          }
          root.style.setProperty(varName, newValue);
          showThemeButtons();
        });
      });
    }

    function showThemeButtons() {
      document.querySelector('.revert-btn').style.display = 'block';
      document.querySelector('.save-btn').style.display = 'block';
    }
    function hideThemeButtons() {
      document.querySelector('.revert-btn').style.display = 'none';
      document.querySelector('.save-btn').style.display = 'none';
    }
    function revertThemeChanges() {
      const root = document.documentElement;
      Object.entries(originalThemeValues).forEach(([varName, value]) => {
        root.style.setProperty(varName, value);
        const input = document.querySelector(`[data-var="${varName}"]`);
        if (input) {
          if (input.type === 'color') {
            input.value = rgbToHex(value);
          } else {
            input.value = input.type === 'number' ? parseInt(value) : value;
          }
        }
      });
      hideThemeButtons();
    }
    function saveThemeChanges() {
      const root = document.documentElement;
      const style = getComputedStyle(root);
      Object.keys(originalThemeValues).forEach(varName => {
        originalThemeValues[varName] = style.getPropertyValue(varName).trim();
      });
      hideThemeButtons();
    }
    async function saveCurrentTheme() {
      const name = document.getElementById('new-theme-name').value.trim();
      if (!name) {
        alert('Please enter a theme name');
        return;
      }
      const colors = {};
      document.querySelectorAll('[data-var]').forEach(input => {
        const varName = input.dataset.var.substring(2);
        let value = getComputedStyle(document.documentElement).getPropertyValue(input.dataset.var).trim();
        if (input.type === 'number') {
          value = value.replace('px', '') + 'px';
        }
        colors[varName] = value;
      });
      try {
        const response = await fetch('/api/themes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, colors })
        });
        if (!response.ok) {
          const error = await response.json();
          alert(error.error);
          return;
        }
        const result = await response.json();
        document.getElementById('new-theme-name').value = '';
        await loadThemes();
        await applyTheme(result.id);
      } catch (error) {
        console.error('Error saving theme:', error);
        alert('Failed to save theme');
      }
    }
    document.addEventListener('DOMContentLoaded', async () => {
      await loadThemes();
      await loadSavedTheme();
      initThemeEditor();
    });
    async function deleteTheme(themeId, event) {
      event.stopPropagation();
      if (!confirm('Are you sure you want to delete this theme?')) return;
      try {
        const response = await fetch(`/api/themes/${themeId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const error = await response.json();
          alert(error.error);
        } else {
          await loadThemes();
        }
      } catch (error) {
        console.error('Error deleting theme:', error);
        alert('Failed to delete theme');
      }
    }

    window.deleteTheme = deleteTheme;
    window.applyTheme = applyTheme;
    window.updateThemeName = updateThemeName;
  </script>
</body>
</html>