<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>masonary layout</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js" defer></script>
</head>
<body>
  <div id="auth-section">
    <form id="login-form">
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <button id="logout-btn" style="display:none;">Logout</button>
  </div>
  <div id="upload-section" style="display:none;">
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" id="image-input" name="image" accept="image/*" multiple required>
      <button type="submit">Upload Image(s)</button>
    </form>
  </div>
  <div class="masonry" id="masonry"></div>

  <script>
    let msnry = null;

    function getToken() {
      return localStorage.getItem('token');
    }

    function setAuthUI(loggedIn) {
      document.getElementById('login-form').style.display = loggedIn ? 'none' : '';
      document.getElementById('logout-btn').style.display = loggedIn ? '' : 'none';
      document.getElementById('upload-section').style.display = loggedIn ? '' : 'none';
    }

    function renderImages(images, loggedIn) {
      const masonry = document.getElementById('masonry');
      masonry.innerHTML = '';
      images.forEach(url => {
        const filename = url.split('/').pop();
        const div = document.createElement('div');
        div.className = 'masonry-item';
        div.innerHTML = `<img src="${url}">`;
        if (loggedIn) {
          const btn = document.createElement('button');
          btn.textContent = 'Delete';
          btn.className = 'delete-btn';
          btn.onclick = () => deleteImage(filename);
          div.appendChild(btn);
        }
        masonry.appendChild(div);
      });
      if (msnry) msnry.destroy();
      msnry = new Masonry('.masonry', {
        itemSelector: '.masonry-item',
        columnWidth: '.masonry-item',
        gutter: 15,
        horizontalOrder: true
      });
    }

    async function loadImages() {
      const res = await fetch('/api/images');
      const images = await res.json();
      const loggedIn = !!getToken();
      renderImages(images, loggedIn);
    }

    document.getElementById('login-form').onsubmit = async e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('token', data.token);
        setAuthUI(true);
        loadImages();
      } else {
        alert('Login failed');
      }
    };

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('token');
      setAuthUI(false);
      loadImages();
    };

    document.getElementById('upload-form').onsubmit = async e => {
      e.preventDefault();
      const fileInput = document.getElementById('image-input');
      if (!fileInput.files.length) return;
      const formData = new FormData();
      for (const file of fileInput.files) {
        formData.append('image', file);
      }
      const res = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + getToken() },
        body: formData
      });
      if (res.ok) {
        fileInput.value = '';
        loadImages();
      } else {
        alert('Upload failed');
      }
    };

    async function deleteImage(filename) {
      if (!confirm('Delete this image?')) return;
      const res = await fetch('/api/images/' + filename, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      if (res.ok) loadImages();
      else alert('Delete failed');
    }

    async function checkLogin() {
      const token = getToken();
      if (!token) {
        setAuthUI(false);
        loadImages();
        return;
      }
      const res = await fetch('/api/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      setAuthUI(data.valid);
      loadImages();
    }

    document.addEventListener("DOMContentLoaded", checkLogin);
  </script>
</body>
</html>