<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>masonary layout</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js" defer></script>
</head>
<body>
  <div id="auth-section">
    <form id="login-form">
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <button id="logout-btn" style="display:none;">Logout</button>
  </div>
  <div id="upload-section" style="display:none;">
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" id="image-input" name="image" accept="image/*" multiple required>
      <button type="submit">Upload Image(s)</button>
    </form>
  </div>
  <div id="delete-selected-section" style="display:none; margin-bottom: 15px;">
    <button id="delete-selected-btn" disabled>Delete Selected</button>
  </div>
  <div class="masonry" id="masonry"></div>

  <script>
    let msnry = null;
    let selectedImages = new Set();
    let loggedInGlobal = false;

    function getToken() {
      return localStorage.getItem('token');
    }

    function setAuthUI(loggedIn) {
      document.getElementById('login-form').style.display = loggedIn ? 'none' : '';
      document.getElementById('logout-btn').style.display = loggedIn ? '' : 'none';
      document.getElementById('upload-section').style.display = loggedIn ? '' : 'none';
      document.getElementById('delete-selected-section').style.display = loggedIn ? '' : 'none';
      loggedInGlobal = loggedIn;
      if (!loggedIn) {
        selectedImages.clear();
        updateDeleteSelectedBtn();
      }
    }

    function updateDeleteSelectedBtn() {
      const btn = document.getElementById('delete-selected-btn');
      btn.disabled = selectedImages.size === 0;
    }

    function renderImages(images, loggedIn) {
      const masonry = document.getElementById('masonry');
      masonry.innerHTML = '';
      const imageElements = [];
      images.forEach(url => {
        const filename = url.split('/').pop();
        const div = document.createElement('div');
        div.className = 'masonry-item';

        // Checkbox for selection
        let checkboxHtml = '';
        if (loggedIn) {
          checkboxHtml = `
            <input type="checkbox" class="select-checkbox" data-filename="${filename}" style="position:absolute;top:8px;left:8px;z-index:2;display:none;">
          `;
        }

        div.innerHTML = `
          ${checkboxHtml}
          <img src="${url}">
        `;

        if (loggedIn) {
          // Show checkbox on hover or if selected
          const checkbox = div.querySelector('.select-checkbox');
          if (selectedImages.has(filename)) {
            checkbox.checked = true;
            checkbox.style.display = 'block';
            div.classList.add('selected');
          }
          div.addEventListener('mouseenter', () => {
            checkbox.style.display = 'block';
          });
          div.addEventListener('mouseleave', () => {
            if (!checkbox.checked) checkbox.style.display = 'none';
          });
          checkbox.addEventListener('change', (e) => {
            if (checkbox.checked) {
              selectedImages.add(filename);
              checkbox.style.display = 'block';
              div.classList.add('selected');
            } else {
              selectedImages.delete(filename);
              checkbox.style.display = 'none';
              div.classList.remove('selected');
            }
            updateDeleteSelectedBtn();
          });
        }

        if (loggedIn) {
          const btn = document.createElement('button');
          btn.innerHTML = '&times;';
          btn.className = 'delete-btn';
          btn.title = 'Delete';
          btn.onclick = () => deleteImage(filename);
          div.appendChild(btn);
        }
        masonry.appendChild(div);
        imageElements.push(div.querySelector('img'));
      });

      // Wait for all images to load before initializing Masonry
      Promise.all(
        imageElements.map(img => {
          if (img.complete) return Promise.resolve();
          return new Promise(resolve => {
            img.onload = img.onerror = resolve;
          });
        })
      ).then(() => {
        if (msnry) msnry.destroy();
        msnry = new Masonry('.masonry', {
          itemSelector: '.masonry-item',
          columnWidth: '.masonry-item',
          gutter: 15,
          horizontalOrder: true
        });
      });
    }

    async function loadImages() {
      const res = await fetch('/api/images');
      const images = await res.json();
      renderImages(images, loggedInGlobal);
    }

    document.getElementById('login-form').onsubmit = async e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('token', data.token);
        setAuthUI(true);
        loadImages();
      } else {
        alert('Login failed');
      }
    };

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('token');
      setAuthUI(false);
      loadImages();
    };

    document.getElementById('upload-form').onsubmit = async e => {
      e.preventDefault();
      const fileInput = document.getElementById('image-input');
      if (!fileInput.files.length) return;
      const formData = new FormData();
      for (const file of fileInput.files) {
        formData.append('image', file);
      }
      const res = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + getToken() },
        body: formData
      });
      if (res.ok) {
        fileInput.value = '';
        loadImages();
      } else {
        alert('Upload failed');
      }
    };

    async function deleteImage(filename) {
      if (!confirm('Delete this image?')) return;
      const res = await fetch('/api/images/' + filename, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      if (res.ok) {
        selectedImages.delete(filename);
        updateDeleteSelectedBtn();
        loadImages();
      }
      else alert('Delete failed');
    }

    async function deleteSelectedImages() {
      if (selectedImages.size === 0) return;
      if (!confirm('Delete selected images?')) return;
      const filenames = Array.from(selectedImages);
      let failed = false;
      for (const filename of filenames) {
        const res = await fetch('/api/images/' + filename, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        if (!res.ok) failed = true;
      }
      selectedImages.clear();
      updateDeleteSelectedBtn();
      loadImages();
      if (failed) alert('Some images could not be deleted.');
    }

    document.getElementById('delete-selected-btn').onclick = deleteSelectedImages;

    async function checkLogin() {
      const token = getToken();
      if (!token) {
        setAuthUI(false);
        loadImages();
        return;
      }
      const res = await fetch('/api/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      setAuthUI(data.valid);
      loadImages();
    }

    document.addEventListener("DOMContentLoaded", checkLogin);
  </script>
</body>
</html>